
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: core-backplane-net-tunneler-old
  namespace: argocd

  annotations:
    argocd.argoproj.io/sync-wave: '1'
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - list:
        elements:
          - cluster: dc1-k3s-node1
            url: https://kubernetes.default.svc
            dc: dc1
            region: yxl
            hub: 'false'
            env: 'prod'
            standby: 'false'

            networking:
              multus:
                enabled: false

            peers:
              - port: '54764'
                name: sbc1.home1.yvr.resolvemy.host
                address: <path:CORE0_SITE1/data/Network/Wireguard/OldTunneler/Home1/SBC1#Address>
                publicKey: <path:CORE0_SITE1/data/Network/Wireguard/OldTunneler/Home1/SBC1#PublicKey>
                server:
                  address: 66.165.222.102

                  privateKey: <path:CORE0_SITE1/data/Network/Wireguard/OldTunneler/Server#PrivateKey>

                  service:
                    enabled: true

                    type: ClusterIP

                    annotations:
                      purelb.io/allow-shared-ip: main-gw.resolvemy.host
                      purelb.io/service-group: core-public
                      purelb.io/allow-local: 'true'

                network:
                  localAddress: 172.31.243.2/30
                  remoteAddress: 172.31.243.1/30
                  allowedIPs: 0.0.0.0/0
                  remotePort: '54764'


            network:
              publicAddress: 66.165.222.102

  syncPolicy:
    preserveResourcesOnDeletion: true

  template:
    metadata:
      name: '{{ .cluster}}-tunneler-{{ .env }}'

      annotations:
        argocd.argoproj.io/manifest-generate-paths: .

    spec:
      project: core
      syncPolicy:
        syncOptions:
          - ServerSideApply=true

      source:
        path: Network/Tunnels
        repoURL: https://github.com/K-FOSS/CoRE-Backplane.git
        targetRevision: HEAD
        plugin:
          name: argocd-lovely-plugin
          env:
            - name: LOVELY_HELM_MERGE
              value: |-
                env: {{ .env }}

                hub: {{ .hub }}

                cluster:
                  name: {{ .cluster }}
                  domain: cluster.local

                peers:
                {{ nindent 2 (toYaml .peers) }}


                datacenter: {{ .dc }}

                region: {{ .region }}

                frr:
                  bgp:
                    enabled: false
                  
                  ospf:
                    enabled: true

                networking:
                  publicAddress: 66.165.222.101

                  routeserver:
                    ipv4Address: 10.1.1.140

      destination:
        server: '{{ .url }}'
        namespace: core-net-tunneler-{{ .env }}
