apiVersion: tf.upbound.io/v1beta1
kind: Workspace
metadata:
  name: {{ include "loki.fullname" $.Subcharts.loki }}

spec:
  providerConfigRef:
    name: authentik

  writeConnectionSecretToRef:
    namespace: {{ .Release.Namespace }}
    name: {{ include "loki.fullname" $.Subcharts.loki }}-sso

  forProvider:
    source: Inline
    module: | # hcl
      data "authentik_flow" "default-authorization-flow" {
        slug = "default-provider-authorization-explicit-consent"
      }

      data "authentik_flow" "default-provider-invalidation-flow" {
        slug = "default-provider-invalidation-flow"
      }

      data "authentik_property_mapping_provider_scope" "logscope" {
        name = "Logs"
      }      

      data "authentik_property_mapping_provider_scope" "scopes" {
        managed_list = [
          "goauthentik.io/providers/oauth2/scope-email",
          "goauthentik.io/providers/oauth2/scope-openid",
          "goauthentik.io/providers/oauth2/scope-profile"
        ]
      }

      data "authentik_user" "akadmin" {
        username = "kjones"
      }

      data "authentik_certificate_key_pair" "cert" {
        name = "tls"
      }

      resource "random_password" "client-secret" {
        length  = 128
        lower   = true
        numeric = true
        upper   = true
        special = true
      }

      resource "authentik_provider_oauth2" "auth-provider" {
        name          = "Loki {{ .Values.cluster.name }} {{ .Values.datacenter }} {{ .Values.region }}"
        client_id     = "{{ .Values.oauth.indexKey }}-{{ .Values.region }}-{{ .Values.datacenter }}-{{ .Values.cluster.name }}"
        client_secret = random_password.client-secret.result
        signing_key = data.authentik_certificate_key_pair.cert.id
        allowed_redirect_uris = [
          {
            matching_mode = "regex",
            url           = "https://logs.{ .Values.cluster.name }}.{{ .Values.datacenter }}.{{ .Values.region }}.mylogin.space/.*",
          },
        ]

        property_mappings  = concat([data.authentik_property_mapping_provider_scope.logscope.id], tolist(data.authentik_property_mapping_provider_scope.scopes.ids))
        authorization_flow = data.authentik_flow.default-authorization-flow.id
        invalidation_flow = data.authentik_flow.default-provider-invalidation-flow.id
      }

      resource "authentik_application" "application" {
        name              = "Loki"
        slug              = "{{ .Values.oauth.indexKey }}-{{ .Values.region }}-{{ .Values.datacenter }}-{{ .Values.cluster.name }}"
        protocol_provider = authentik_provider_oauth2.auth-provider.id
        meta_launch_url   = "blank://blank"
      }

      {{ range $index, $group := .Values.oauth.groups }}
      data "authentik_group" "group-{{ $index }}" {
        name = "{{ $group }}"
      } 

      resource "authentik_application_entitlement" "ent-{{ $index }}" {
        name        = "${data.authentik_group.group-{{ $index }}.id}-ent"
        application = authentik_application.application.uuid
      }

      resource "authentik_policy_binding" "ent-{{ $index }}-access" {
        target = authentik_application_entitlement.ent-{{ $index }}.id
        group  = data.authentik_group.group-{{ $index }}.id
        order  = {{ $index }}
      } 

      resource "authentik_policy_binding" "ent-{{ $index }}-app-access" {
        target = authentik_application.application.uuid
        group  = data.authentik_group.group-{{ $index }}.id
        order  = {{ $index }}
      }

      {{ end }}

      output "client_id" {
        value     = "{{ .Values.oauth.indexKey }}-{{ .Values.region }}-{{ .Values.datacenter }}-{{ .Values.cluster.name }}"
        sensitive = true
      }

      output "client-secret" {
        value     = random_password.client-secret.result
        sensitive = true
      }