apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  {{ $group := .Values.cluster.group }}
  {{ $name := .Values.cluster.kind }}
  
  name: x{{ $name | lower }}s.{{ $group }}
spec:
  group: {{ $group }}

  names:
    kind: X{{ $name }}
    plural: x{{ $name | lower }}s

  claimNames:
    kind: {{ .Values.cluster.kind }}
    plural: {{ $name | lower }}s
  
  connectionSecretKeys:
    - talosconfig
    - kubeconfig

  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                name:
                  type: string
                  description: Friendly name of the cluster

                description:
                  type: string
                  description: Additonal notes and description about the deployed cluster

                danger:
                  type: object

                  description: This is the section that controls dangerous server actions beware

                  properties:
                    warningdonotdounlessyouknowwhatyouaredoing:
                      type: object

                      description: If you have come this far traveler you must be careful

                      properties:
                        wipeOnReboot:
                          type: boolean

                          description: Wipe the server on the next reboot by adding the reset kernel parameter

                metadata:
                  type: object

                  description: Additonal relevant metadata and regional details


                  properties:
                    clusterID:
                      type: integer
                      default: 1

                      description: Cluster ID, used for Cilium install for multi cluster mesh, must be unique within tenant scope


                    datacenter:
                      type: string
                      description: Datacenter ID

                    region:
                      type: string
                      description: Datacenter/cluster Region

                tenantRef:
                  type: object
                  description: Tenant ref to attach details to the deployed cluster
                  properties:
                    group:
                      type: string

                      default: {{ .Values.tenant.group }}

                    kind:
                      type: string

                      default: {{ .Values.tenant.kind }}

                    name:
                      type: string

                    namespace:
                      type: string


                environment:
                  type: string
                  description: env of the deployed cluster

                bgp:
                  type: object

                  description: BGP configurations for the cluster

                  default:
                    instances: []

                  properties:
                    instances:
                      type: array

                      items:
                        type: object

                        properties:
                          asn:
                            type: integer

                          name:
                            type: string

                          peers:
                            type: array

                            description: BGP Peers

                            items:
                              type: object

                              properties:
                                name:
                                  type: string
                              
                                address:
                                  type: string

                                asn:
                                  type: integer

                versions:
                  type: object
                  properties:
                    kubernetes:
                      type: string

                      default: v1.32.1
                    
                    talos:
                      type: string
                  
                      default: v1.9.4

                clustertype:
                  type: string
                  enum:
                    - infra
                    - init
                    - compute

                computetype:
                  type: string
                  enum:
                    - baremetal
                    - vm

                domain:
                  type: string

                  default: cluster.local

                networks:
                  type: object

                  description: Network configuration of the cluster
                  properties:
                    loadbalancer:
                      type: object
                      description: Load balancer IP addresses, generally handled by PureLB
                      properties:
                        networks:
                          type: array

                          items:
                            type: object

                            description: PureLB Load Balancer Configuration

                            properties:
                              name:
                                type: string

                              pools:
                                type: array

                                items:
                                  type: object

                                  properties:
                                    subnet:
                                      type: string

                                    pool:
                                      type: string

                                    aggregation:
                                      type: string

                        anycast:
                          type: string

                        public:
                          type: string

                        pool:
                          type: string
                    
                    services:
                      type: string
                      description: pool used for the services within the cluster

                    pods:
                      type: string
                      description: IP Pool assigned to pods within the deployed cluster

                type:
                  type: string

                  enum:
                    - talos

                controlplane:
                  type: object
                  properties:
                    ipAddress:
                      type: string

              required:
                - name
                - environment
                - tenantRef
                - networks
                - type
                - controlplane
            status:
              description: A Status represents the observed state
              properties:
                share:
                  description: Freeform field containing status information
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
              type: object