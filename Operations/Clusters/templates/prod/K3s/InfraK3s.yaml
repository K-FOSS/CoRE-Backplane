{{- define "argocd-label" }}
argocd.argoproj.io/instance: {{ $.Release.Name }}
{{- end }}

{{- define "argocd-annotation" }}
argocd.argoproj.io/tracking-id: {{ $.Release.Name }}:infrastructure.cluster.x-k8s.io/VCluster:core-prod/k3s-legacy
{{- end }}

{{- define "argocd-index" }}
labels:
  {{- include "argocd-label" $ | indent 2 }}
annotations:
  {{- include "argocd-annotation" $ | indent 2 }}
{{- end }}


apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: VCluster
metadata:
  name: k3s-legacy

  namespace: core-prod
spec:
  helmRelease:
    chart:
      version: '0.32.0-next.0'
    values: |-
      controlPlane:
        statefulSet:
          enableServiceLinks: false
          {{- include "argocd-index" $ | nindent 10 }}

        proxy:
          # ExtraSANs are extra hostnames to sign the vCluster proxy certificate for.
          extraSANs:
            - k3s-legacy.resolvemy.host
        service:
          # Enabled defines if the control plane service should be enabled
          enabled: true
          labels:
            wan-mode: 'public'
            {{- include "argocd-label" $ | indent 12 }}
          annotations:
            external-dns.alpha.kubernetes.io/hostname: 'k3s-legacy.resolvemy.host'
            {{- include "argocd-annotation" $ | indent 12 }}

        advanced:
          serviceAccount:
            # Enabled specifies if the service account should get deployed.
            enabled: true
            {{- include "argocd-index" $ | nindent 12 }}


      deploy:
        # LocalPathProvisioner holds dedicated local path provisioner configuration.
        localPathProvisioner:
          # Enabled defines if LocalPathProvisioner should be enabled.
          enabled: false
        
        # CNI holds dedicated CNI configuration.
        cni:
          # Flannel holds dedicated Flannel configuration.
          flannel:
            # Enabled defines if Flannel should be enabled.
            enabled: false

        kubeProxy:
          # Enabled defines if the kube proxy should be enabled.
          enabled: false

  # controlPlaneEndpoint represents the endpoint used to communicate with the control plane.
  # You may leave this field empty, and then CAPVC will try to fill in this information based
  # on the network resources created by the chart (Service, Ingress).
  # The vcluster chart provides options to create a service of LoadBalancer type by setting
  # Helm value - `.service.type: "LoadBalancer"`, or creating an Ingress by setting Helm value
  # `.ingress.enabled: true` and `.ingress.host`. You can explore all options in the charts
  # folder of our vcluster repo - https://github.com/loft-sh/vcluster/tree/main/charts
  #
  # We also recommend reading official vcluster documentation page on this topic:
  # https://www.vcluster.com/docs/operator/external-access
  # this page outlines additional Helm values that you will need to set in certain cases, e.g.
  # `.syncer.extraArgs: ["--tls-san=myvcluster.mydns.abc"]`
  #
  # This field, and all it's sub-fields, are optional.
  controlPlaneEndpoint:
    host: k3s-legacy.resolvemy.host
    port: 443