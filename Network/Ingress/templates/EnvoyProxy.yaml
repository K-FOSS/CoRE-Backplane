apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: envoy-{{ .Values.tenant }}
spec:
  logging:
    level:
      default: error
  mergeGateways: false

  concurrency: 4

  provider:
    kubernetes:
      envoyDeployment:
        container:
          resources:
            limits:
              cpu: '4'
              memory: '4Gi'
            requests:
              cpu: 16m
              memory: 256Mi
        pod:
          labels:
            logs: loki-myloginspace
        replicas: 3

      envoyPDB:
        maxUnavailable: 25%
      envoyService:
        externalTrafficPolicy: Local
        type: LoadBalancer
        patch:
          type: StrategicMerge
          value:
            spec:
              sessionAffinity: ClientIP
              sessionAffinityConfig:
                clientIP:
                  timeoutSeconds: 1080


    type: Kubernetes

  telemetry:
    accessLog:
      disable: true
      settings:
        - format:
            json:
              message: '%LOCAL_REPLY_BODY%'
              status: '%RESPONSE_CODE%'
            type: JSON
          sinks:
            - openTelemetry:
                backendRefs:
                  - group: ''
                    kind: Service
                    name: {{ .Values.cluster.name }}-collectors-alloy
                    namespace: core-prod
                    port: 4317
              type: OpenTelemetry
    tracing:
      provider:
        backendRefs:
          - group: ''
            kind: Service
            name: {{ .Values.cluster.name }}-collectors-alloy
            namespace: core-prod
            port: 4317
        type: OpenTelemetry
      samplingRate: 10
