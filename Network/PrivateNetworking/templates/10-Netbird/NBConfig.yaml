{{- if .Values.netbird.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "bjw-s.common.lib.chart.names.fullname" . }}-netbird-config
data:
  management.json: |
      {
        "Stuns": [
          {{- range $i, $server := $.Values.stunServers }}
          {
            "Proto": "udp",
            "URI": "stun:{{ $server.hostname }}:{{ $server.port }}",
            "Username": "",
            "Password": null
          } {{ len $.Values.stunServers }} {{ $i }}
          {{ end -}}
        ],
        "TURNConfig": {
          "Turns": [
          {{- range $i, $server := $.Values.stunServers }}
          {
            "Proto": "udp",
            "URI": "turn:{{ $server.hostname }}:{{ $server.port }}",
            "Username": "",
            "Password": null
          }
          {{ end -}}
          ],
          "CredentialsTTL": "12h",
          "Secret": "",
          "TimeBasedCredentials": false
        },
        "Signal": {
          "Proto": "http",
          "URI": ":{{ .Values.netbird.signal.port }}",
          "Username": "",
          "Password": null
        },
        "Datadir": "",
        "HttpConfig": {
          "Address": "0.0.0.0:80",
          "AuthIssuer": "{{ .Values.netbird.auth.oidc.provider }}/",
          "AuthAudience": "{{`{{ .OIDCClientID }}`}}",
          "AuthKeysLocation": "{{ .Values.netbird.auth.oidc.provider }}/jwks/",
          "OIDCConfigEndpoint": "{{ .Values.netbird.auth.oidc.provider }}/.well-known/openid-configuration"
        },
        "IdpManagerConfig": {
          "ManagerType": "authentik",
          "ClientConfig": {
            "Issuer": "https://idp.example.com/application/o/example-netbird",
            "TokenEndpoint": "https://idp.example.com/application/o/token/",
            "ClientID": "{{ .IDP_CLIENT_ID }}",
            "ClientSecret": "",
            "GrantType": "client_credentials"
          },
          "ExtraConfig": {
            "Password": "{{ .IDP_SERVICE_ACCOUNT_PASSWORD }}",
            "Username": "{{ .IDP_SERVICE_ACCOUNT_USER }}"
          },
          "Auth0ClientCredentials": null,
          "AzureClientCredentials": null,
          "KeycloakClientCredentials": null,
          "ZitadelClientCredentials": null
        },
        "DeviceAuthorizationFlow": {
          "Provider": "hosted",
          "ProviderConfig": {
            "Audience": "{{`{{ .OIDCClientID }}`}}",
            "Domain": "{{ .Values.netbird.auth.oidc.provider }}",
            "TokenEndpoint": "{{ .Values.netbird.auth.oidc.tokenEndpoint }}"
          }
        }
      }
{{- end }}