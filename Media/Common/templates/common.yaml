---
{{- include "bjw-s.common.loader.init" . }}

{{- define "app-template.hardcodedValues" -}}

global:
  nameOverride: "{{ .Release.Name }}"

  fullnameOverride: core-media


controllers:
  sabnzbd:
    # For Deployments, valid values are Recreate (default) and RollingUpdate.
    # For StatefulSets, valid values are OnDelete and RollingUpdate (default).
    # DaemonSets/CronJobs ignore this.
    strategy: RollingUpdate

    enabled: false

    name: sabnzbd

    containers:
      sabnzbd:
        image:
          repository: linuxserver/sabnzbd
          tag: latest
          pullPolicy: IfNotPresent

        ports:
          - name: http
            containerPort: 8080

  {{- if $.Values.flaresolverr.enabled }}
  flaresolverr:
    # For Deployments, valid values are Recreate (default) and RollingUpdate.
    # For StatefulSets, valid values are OnDelete and RollingUpdate (default).
    # DaemonSets/CronJobs ignore this.
    strategy: RollingUpdate

    enabled: true

    name: flaresolverr

    containers:
      flaresolverr:
        image:
          repository: {{ $.Values.flaresolverr.image }}
          tag: {{ default "latest" $.Values.flaresolverr.tag }}
          pullPolicy: IfNotPresent

        env:
          - name: LOG_LEVEL
            value: 'info'

          - name: LOG_FILE
            value: 'none'

          - name: LOG_HTML
            value: 'none'

          - name: TZ
            value: 'America/Vancouver'

          - name: CAPTCHA_SOLVER
            value: 'none'

        ports:
          - name: http
            containerPort: 8191
  {{- end }}

persistence:
  {{- if .Values.flaresolverr.volumes.config.enabled }}
  flaresolverr-config:
    enabled: true
    type: persistentVolumeClaim 
    accessMode: ReadWriteOnce
    size: {{ .Values.flaresolverr.volumes.config.size }}
    advancedMounts:
      flaresolverr:
        flaresolverr:
          - path: /config
  {{- end }}

  {{- if and .Values.volumes.enabled .Values.volumes.media.enabled }}
  media:
    enabled: true
    type: persistentVolumeClaim 

    forceRename: {{ .Values.tenant.name }}-media
    accessMode: ReadWriteMany
    size: {{ .Values.volumes.media.size }}
  {{- end }}

  {{- if and .Values.volumes.enabled .Values.volumes.downloads.enabled }}
  downloads:
    enabled: true
    type: persistentVolumeClaim 

    forceRename: {{ .Values.tenant.name }}-downloads
    accessMode: ReadWriteMany
    size: {{ .Values.volumes.downloads.size }}
  {{- end }}

service:
  {{- if $.Values.flaresolverr.enabled }}
  flaresolverr:
    # -- Enables or disables the service
    enabled: true

    # -- Configure which controller this service should target
    controller: flaresolverr

    # -- Make this the primary service for this controller (used in probes, notes, etc...).
    # If there is more than 1 service targeting the controller, make sure that only 1 service is
    # marked as primary.
    primary: true

    # -- Set the service type
    type: ClusterIP

    # -- Specify the externalTrafficPolicy for the service. Options: Cluster, Local
    # -- [[ref](https://kubernetes.io/docs/tutorials/services/source-ip/)]
    #externalTrafficPolicy: Local

    # -- Specify the ip policy. Options: SingleStack, PreferDualStack, RequireDualStack
    ipFamilyPolicy:
    # -- The ip families that should be used. Options: IPv4, IPv6
    ipFamilies: []

    # -- Provide additional annotations which may be required.
    #annotations:

    # -- Provide additional labels which may be required.
    labels: {}

    # -- Allow adding additional match labels
    extraSelectorLabels: {}

    ports:
      http:
        # -- Enables or disables the port
        enabled: true

        # -- Make this the primary port (used in probes, notes, etc...)
        # If there is more than 1 service, make sure that only 1 port is marked as primary.
        primary: true

        # -- The port number
        port: 80

        targetPort: http

        # -- Port protocol.
        # Support values are `HTTP`, `HTTPS`, `TCP` and `UDP`.
        # HTTP and HTTPS spawn a TCP service and get used for internal URL and name generation
        protocol: TCP

        # -- Specify the appProtocol value for the Service.
        # [[ref]](https://kubernetes.io/docs/concepts/services-networking/service/#application-protocol)
        appProtocol:  
  {{- end }}

{{- end -}}
{{- $_ := mergeOverwrite .Values (include "app-template.hardcodedValues" . | fromYaml) -}}

{{/* Render the templates */}}
{{ include "bjw-s.common.loader.generate" . }}