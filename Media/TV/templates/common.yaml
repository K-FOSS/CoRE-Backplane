---
{{- include "bjw-s.common.loader.init" . }}

{{- define "app-template.hardcodedValues" -}}
# Set the nameOverride based on the release name if no override has been set
{{ if not .Values.global.nameOverride }}
global:
  nameOverride: "{{ .Release.Name }}"
{{ end }}

controllers:
  #
  # Sonarr
  #
  {{- if $.Values.sonarr.enabled }}
  sonarr:
    # For Deployments, valid values are Recreate (default) and RollingUpdate.
    # For StatefulSets, valid values are OnDelete and RollingUpdate (default).
    # DaemonSets/CronJobs ignore this.
    strategy: Recreate

    name: sonarr

    pod:
      securityContext:
        fsGroup: 911
        runAsUser: 911
        runAsGroup: 911
        fsGroupChangePolicy: "OnRootMismatch"

    containers:
      sonarr:
        image:
          repository: {{ $.Values.sonarr.image }}
          tag: {{ default "latest" $.Values.sonarr.tag }}
          pullPolicy: IfNotPresent

        ports:
          - name: http
            containerPort: 8989
  {{- end }}

  {{- if .Values.prefetcharr.enabled }}
  prefetcharr:
    # For Deployments, valid values are Recreate (default) and RollingUpdate.
    # For StatefulSets, valid values are OnDelete and RollingUpdate (default).
    # DaemonSets/CronJobs ignore this.
    strategy: Recreate

    name: prefetcharr

    pod:
      securityContext:
        fsGroup: 911
        runAsUser: 911
        runAsGroup: 911
        fsGroupChangePolicy: "OnRootMismatch"

    containers:
      prefetcharr:
        image:
          repository: {{ $.Values.prefetcharr.image }}
          tag: {{ default "latest" $.Values.prefetcharr.tag }}
          pullPolicy: IfNotPresent

        env:
          - name: PREFETCHARR_CONFIG
            valueFrom:
              configMapKeyRef:
                name: prefetcharr-config
                key: config.toml
  {{- end }}

persistence:
  {{- if .Values.sonarr.volumes.config.enabled }}
  sonarr-config:
    enabled: true
    type: persistentVolumeClaim 
    accessMode: ReadWriteOnce
    size: 2G
    advancedMounts:
      sonarr:
        sonarr:
          - path: /config
  {{- end }}

  {{- if .Values.sonarr.volumes.media.enabled }}
  media:
    enabled: true
    type: persistentVolumeClaim

    existingClaim: {{ .Values.tenant.name }}-media

    advancedMounts:
      sonarr:
        sonarr:
          - path: /Media
  {{- end }}

  {{- if .Values.sonarr.volumes.downloads.enabled }}
  downloads:
    enabled: true
    type: persistentVolumeClaim

    existingClaim: {{ .Values.tenant.name }}-downloads

    advancedMounts:
      sonarr:
        sonarr:
          - path: /downloads
  {{- end }}

configMaps:
  {{- if $.Values.sonarr.enabled }}
  sonarr-config:
    enabled: true
    data:
      config.xml: |
        <Config>
          <BindAddress>*</BindAddress>
          <Port>8989</Port>
          <SslPort>9898</SslPort>
          <EnableSsl>False</EnableSsl>
          <LaunchBrowser>True</LaunchBrowser>
          <ApiKey>{{`{{ .APIKey }}`}}</ApiKey>
          <AuthenticationMethod>Forms</AuthenticationMethod>
          <AuthenticationRequired>Enabled</AuthenticationRequired>
          <Branch>main</Branch>
          <LogLevel>debug</LogLevel>
          <SslCertPath></SslCertPath>
          <SslCertPassword></SslCertPassword>
          <UrlBase></UrlBase>
          <InstanceName>Sonarr</InstanceName>
          <UpdateMechanism>Docker</UpdateMechanism>
        </Config>
  {{- end }}

  {{- if .Values.prefetcharr.enabled }}
  prefetcharr-config:
    # -- Enables or disables the configMap
    enabled: true
    # -- Labels to add to the configMap
    labels: {}
    # -- Annotations to add to the configMap
    annotations: {}
    # -- configMap data content. Helm template enabled.
    data:
      config.toml: |
        # Start of the configuration in TOML format.
       
        interval = 300           # Polling interval in seconds
        log_dir = "/log"         # Logging directory
        log_level = "Debug"      # `Trace`, `Debug`, `Info`, `Warn` or `Error`
        prefetch_num = 2         # Number of episodes to make available in advance
        request_seasons = false   # Always request full seasons to prefer season packs
        connection_retries = 6   # Number of retries for the initial connection probing

        [media_server]
        type = "Jellyfin"                       # `Jellyfin`, `Emby`, `Plex` or `Tautulli`
        url = "https://stream.mylogin.space"    # Jellyfin/Emby/Plex/Tautulli baseurl
        api_key = "{{`{{ .JellyfinAPIKey }}`}}"             # Jellyfin/Emby/Tautulli API key or plex server token
        # users = [ "John", "12345", "Axel F" ] # Optional: Only monitor sessions for specific user IDs or names
        libraries = [ "TV Shows"]   # Optional: Only monitor sessions for specific libraries

        [sonarr]
        url = "http://example.com/sonarr" # Sonarr baseurl
        api_key = "<YOUR KEY HERE>"       # Sonarr API key
        # exclude_tag = "no_prefetch"     # Optional: Exclude series by tag
  {{- end }}

service:
  {{- if $.Values.sonarr.enabled }}
  sonarr:
    # -- Enables or disables the service
    enabled: true

    # -- Configure which controller this service should target
    controller: sonarr

    # -- Make this the primary service for this controller (used in probes, notes, etc...).
    # If there is more than 1 service targeting the controller, make sure that only 1 service is
    # marked as primary.
    primary: true

    # -- Set the service type
    type: ClusterIP

    # -- Specify the externalTrafficPolicy for the service. Options: Cluster, Local
    # -- [[ref](https://kubernetes.io/docs/tutorials/services/source-ip/)]
    #externalTrafficPolicy: Local

    # -- Specify the ip policy. Options: SingleStack, PreferDualStack, RequireDualStack
    ipFamilyPolicy:
    # -- The ip families that should be used. Options: IPv4, IPv6
    ipFamilies: []

    # -- Provide additional annotations which may be required.
    #annotations:

    # -- Provide additional labels which may be required.
    labels: {}

    # -- Allow adding additional match labels
    extraSelectorLabels: {}

    ports:
      http:
        # -- Enables or disables the port
        enabled: true

        # -- Make this the primary port (used in probes, notes, etc...)
        # If there is more than 1 service, make sure that only 1 port is marked as primary.
        primary: true

        # -- The port number
        port: 80

        targetPort: http

        # -- Port protocol.
        # Support values are `HTTP`, `HTTPS`, `TCP` and `UDP`.
        # HTTP and HTTPS spawn a TCP service and get used for internal URL and name generation
        protocol: TCP

        # -- Specify the appProtocol value for the Service.
        # [[ref]](https://kubernetes.io/docs/concepts/services-networking/service/#application-protocol)
        appProtocol:  
  {{- end }}

route:
  {{- if .Values.sonarr.enabled }}
  sonarr:
    # -- Enables or disables the route
    enabled: true

    # -- Set the route kind
    # Valid options are GRPCRoute, HTTPRoute, TCPRoute, TLSRoute, UDPRoute
    kind: HTTPRoute

    # -- Provide additional labels which may be required.
    labels:
      wan-mode: 'public'
      lan-mode: 'private'

    hostnames:
      - movies.mylogin.space

    # -- Configure the resource the route attaches to.
    parentRefs:
      - # Group of the referent resource.
        group: gateway.networking.k8s.io

        # Kind of the referent resource.
        kind: Gateway

        # Name of the referent resource
        name: {{ $.Values.pubgateway.name }}

        sectionName: {{ $.Values.pubgateway.sectionName }}

        # Namespace of the referent resource
        namespace: {{ $.Values.pubgateway.namespace }}

    # -- Configure rules for routing. Defaults to the primary service.
    rules:
      - backendRefs:
          - kind: Service
            port: 80
            identifier: sonarr
            weight: 1
  {{- end }}



{{- end -}}
{{- $_ := mergeOverwrite .Values (include "app-template.hardcodedValues" . | fromYaml) -}}

{{/* Render the templates */}}
{{ include "bjw-s.common.loader.generate" . }}