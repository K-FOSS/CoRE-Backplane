apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: psql-{{ .Values.datacenter }}-{{ .Values.region }}

  labels:
    wan-mode: public

  annotations:
    acid.zalan.do/controller: '{{ .Values.psql.controllerID }}'

spec:
  teamId: psql-site-{{ .Values.datacenter }}-{{ .Values.region }}
  volume:
    size: 10Gi

    storageClass: nvme-nonredundant

  numberOfInstances: 1

  masterServiceAnnotations:
    external-dns.alpha.kubernetes.io/hostname: 'psql-local.{{ .Values.cluster.name }}.{{ .Values.datacenter }}.{{ .Values.region }}.mylogin.space'

  postgresql:
    version: '17'

  users:
    opsadmin:
      - superuser
      - createdb
      - LOGIN

  patroni:
    synchronous_mode: false

    pg_hba:
      - local all         all                  trust
      - local replication standby              md5
      - host replication  replicator 0.0.0.0/0 md5
      - host replication  standby    0.0.0.0/0 md5
      - host all          postgres   0.0.0.0/0 md5
      - host all          pooler     0.0.0.0/0 md5
      - host all          opsadmin   0.0.0.0/0 md5
      - host all          all        0.0.0.0/0 ldap ldapserver=ldap-home1.mylogin.space ldapport=389 ldapbasedn="ou=users,dc=ldap,dc=mylogin,dc=space" ldapbinddn="cn=<path:CORE0_SITE1/data/PSQL/LDAP#Username>,ou=users,dc=ldap,dc=mylogin,dc=space" ldapbindpasswd="<path:CORE0_SITE1/data/PSQL/LDAP#Password>" ldapsearchattribute="cn"


  tls:
    secretName: 'myloginspace-default-certificates'
    certificateFile: 'tls.crt'
    privateKeyFile: 'tls.key'