{{ if .Values.psql.hub }}

apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: psql-main

  labels:
    wan-mode: public
    lan-mode: private

spec:
  teamId: core

  numberOfInstances: 3

  users:
    zalando:  # database owner
      - superuser
      - createdb

    opsadmin:
      - superuser
      - createdb
      - LOGIN

    foo_user: []

  databases:
    foo: zalando  
    ops: opsadmin

  enableMasterLoadBalancer: true

  masterServiceAnnotations: {}

  enableConnectionPooler: true

  allowedSourceRanges:  # load balancers' source ranges for both master and replica services
    - 0.0.0.0/0

  # preparedDatabases:
  #   bar:
  #     defaultUsers: true

  #     extensions:
  #       pg_partman: public
  #       pgcrypto: public

  #     schemas:
  #       data: {}
  #       history:
  #         defaultRoles: true
  #         defaultUsers: false

  postgresql:
    version: '15'

#  env:
#  - name: wal_s3_bucket
#    value: my-custom-bucket

  volume:
    size: 50Gi

#  spiloRunAsUser: 101
#  spiloRunAsGroup: 103
#  spiloFSGroup: 103

#  podAnnotations:
#    annotation.key: value

#  serviceAnnotations:
#    annotation.key: value

#  podPriorityClassName: "spilo-pod-priority"

#  tolerations:
#  - key: postgres
#    operator: Exists
#    effect: NoSchedule

  resources:
    requests:
      cpu: 10m
      memory: 100Mi

    limits:
      cpu: 4000m
      memory: 5G

  patroni:
    failsafe_mode: false

    initdb:
      encoding: 'UTF8'
      locale: 'en_US.UTF-8'
      data-checksums: 'true'

#    pg_hba:
#      - hostssl all all 0.0.0.0/0 md5
#      - host    all all 0.0.0.0/0 md5

#    slots:
#      permanent_physical_1:
#        type: physical

#      permanent_logical_1:
#        type: logical
#        database: foo
#        plugin: pgoutput

    ttl: 30

    loop_wait: 10

    retry_timeout: 10

    synchronous_mode: false

    synchronous_mode_strict: false

    synchronous_node_count: 1

    maximum_lag_on_failover: 33554432

  # restore a Postgres DB with point-in-time-recovery
  # with a non-empty timestamp, clone from an S3 bucket using the latest backup before the timestamp
  # with an empty/absent timestamp, clone from an existing alive cluster using pg_basebackup
  # clone:
  #   cluster: 'core'
  #   s3_endpoint: <path:CORE0_SITE1/data/PSQL/S3#Endpoint>
  #   s3_access_key_id: <path:CORE0_SITE1/data/PSQL/S3#AccessKey>
  #   s3_secret_access_key: <path:CORE0_SITE1/data/PSQL/S3#SecretKey>
  #   s3_wal_path: s3://psql-backups/spilo/core/wal/14
  #   timestamp: "2023-12-19T12:40:33+01:00"

# run periodic backups with k8s cron jobs
#  enableLogicalBackup: true
#  logicalBackupSchedule: "30 00 * * *"

#  maintenanceWindows:
#  - 01:00-06:00  #UTC
#  - Sat:00:00-04:00

# overwrite custom properties for connection pooler deployments
  connectionPooler:
    numberOfInstances: 3
    mode: transaction
    schema: pooler
    user: pooler
    maxDBConnections: 200

  # initContainers:
  # - name: date
  #   image: busybox
  #   command: [ "/bin/date" ]

#  sidecars:
#   - name: "telegraf-sidecar"
#     image: "telegraf:latest"
#     ports:
#     - name: metrics
#       containerPort: 8094
#       protocol: TCP
#     resources:
#       limits:
#         cpu: 500m
#         memory: 500Mi
#       requests:
#         cpu: 100m
#         memory: 100Mi
#     env:
#       - name: "USEFUL_VAR"
#         value: "perhaps-true"

  # Custom TLS certificate. Disabled unless tls.secretName has a value.
  tls:
    secretName: 'myloginspace-default-certificates'  # should correspond to a Kubernetes Secret resource to load
    certificateFile: 'tls.crt'
    privateKeyFile: 'tls.key'
    caFile: ''  # optionally configure Postgres with a CA certificate
    caSecretName: '' # optionally the ca.crt can come from this secret instead.
# file names can be also defined with absolute path, and will no longer be relative
# to the "/tls/" path where the secret is being mounted by default, and "/tlsca/"
# where the caSecret is mounted by default.
# When TLS is enabled, also set spiloFSGroup parameter above to the relevant value.
# if unknown, set it to 103 which is the usual value in the default spilo images.
# In Openshift, there is no need to set spiloFSGroup/spilo_fsgroup.

# Add node affinity support by allowing postgres pods to schedule only on nodes that
# have label: "postgres-operator:enabled" set.
#  nodeAffinity:
#    requiredDuringSchedulingIgnoredDuringExecution:
#      nodeSelectorTerms:
#        - matchExpressions:
#            - key: postgres-operator
#              operator: In
#              values:
#                - enabled

# Enables change data capture streams for defined database tables
#  streams:
#  - applicationId: test-app
#    database: foo
#    tables:
#      data.state_pending_outbox:
#        eventType: test-app.status-pending
#      data.state_approved_outbox:
#        eventType: test-app.status-approved
#      data.orders_outbox:
#        eventType: test-app.order-completed
#        idColumn: o_id
#        payloadColumn: o_payload
#    # Optional. Filter ignores events before a certain txnId and lsn. Can be used to skip bad events
#    filter:
#      data.orders_outbox: "[?(@.source.txId > 500 && @.source.lsn > 123456)]"
#    batchSize: 1000

{{- end }}