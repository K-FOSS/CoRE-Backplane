apiVersion: dragonflydb.io/v1alpha1
kind: Dragonfly
metadata:
  name: dragonfly-core
spec:
  replicas: 2

  authentication:
    passwordFromSecret:
      key: password
      name: dragonfly-core-password

  serviceSpec:
    annotations:
      external-dns.alpha.kubernetes.io/hostname: dragonfly.{{ .Values.cluster.name }}.{{ .Values.datacenter }}.{{ .Values.region }}.mylogin.space
    labels:
      wan-mode: public

  tlsSecretRef:
    name: myloginspace-default-certificates
    namespace: core-prod

  env:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: dragonfly-core-s3-creds
          key: AccessKey

    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: dragonfly-core-s3-creds
          key: SecretAccessKey

    - name: AWS_SESSION_TOKEN
      valueFrom:
        secretKeyRef:
          name: dragonfly-core-s3-creds
          key: SessionToken

  args:
    - --proactor_threads=2
    - --lock_on_hashtags
    - --s3_endpoint=s3.{{ .Values.cluster.name }}.{{ .Values.datacenter }}.{{ .Values.region }}.mylogin.space

  annotations:
    secret.reloader.stakater.com/reload: 'dragonfly-core-s3-creds,dragonfly-core-password'

  snapshot:
    cron: '*/5 * * * *'
    dir: 's3://dragonfly-core-{{ .Values.region }}-{{ .Values.datacenter }}-{{ .Values.cluster.name }}/core'

  resources:
    requests:
      cpu: 500m
      memory: 500Mi

    limits:
      cpu: '2'
      memory: 750Mi